
<html>
<body id="4">

    <script type="text/javascript" src="Wav.js"></script>
    <script type="text/javascript" src="WtOsc.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/codemirror/4.5.0/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/codemirror/4.5.0/codemirror.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/codemirror/4.5.0/mode/javascript/javascript.js"></script>
    <style>

        body {
            font-family: Tahoma;
        }

        .codeEditor {
            width:800px;
            height:200px; 
            border: 1px solid #999;
            margin: 5px;
        }

		.controls {
			border: 1px solid #999;
			margin: 5px;
			width: 800px;
		}

		.controls table {
			width: 49%;
			border: 0px solid red;
			display: inline-block;
		}

        .controls a {
            font-size: 14pt;
            text-decoration: none;
            font-weight: bold;
            color: #555;
			cursor: pointer;
        }

        .controls a:hover {
            color: #777;
        }

    </style>
<script type="text/javascript">

    var N = 1024;
    var wavetableCount = 256;
    var wavetable = new Array(wavetableCount);

    var wt = {};

    function compileScript() {
        //var text = document.getElementById('scriptTextarea').value;
        var text = wt.codeEditor.getValue();
        eval(text);
    }

    function recompute() {

        try {
            wt.errorEditor.setValue("");

            compileScript();
            if (wt.initialize !== null)
                wt.initialize(N, wavetableCount);

            for (var k = 0; k < wavetableCount; k++) {
                wavetable[k] = wt.makeWave(k, N, wavetableCount);
            }

            updateWave();
            scriptError.style.visibility = 'collapse';
            scriptError.style.height = '0';
        }
        catch (ex)
        {
        	scriptError.style.visibility = 'visible';
        	scriptError.style.height = '200px';
        	wt.errorEditor.setValue(ex.message + '\n' + ex.stack);
        }
    }

    function updateWave() {
        var slider = document.getElementById('waveSlider').value;
        var k = Math.round(slider * (wavetableCount - 1));
        var selectedWave = wavetable[k];
        window.WtOsc.wave = selectedWave;
        paintWave(selectedWave);
    }

    function paintWave(wave) {
        var canvas = document.getElementById('canvas');
        var width = canvas.width;
        var height = canvas.height;
        var ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, width, height);

        ctx.beginPath();
        ctx.moveTo(0, 0.1 * height);
        ctx.lineTo(width, 0.1 * height);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#999';
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, 0.9 * height);
        ctx.lineTo(width, 0.9 * height);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#999';
        ctx.stroke();

        ctx.beginPath();
        for (var i = 0; i < wave.length; i++) {
            var x = i / wave.length * width;
            var y = -wave[i] * height / 2 * 0.8 + height / 2;

            if (i == 0)
                ctx.moveTo(x, y);
            else
                ctx.lineTo(x, y);
        }

        ctx.lineWidth = 1.5;
        ctx.strokeStyle = "#555";
        ctx.stroke();

    }

    function downloadWave() {
        var vol = 0.8;
        var wav = new Wav();
        var buffer = [];

        for (var k = 0;  k < wavetable.length; k++) {
            var wave = wavetable[k];
            for (var n = 0; n < wave.length; n++) {
                buffer.push(wave[n] * vol);
            }
        }

        wav.setBuffer(buffer);
        var b = wav.getBlob();
        var url = window.URL.createObjectURL(b);
        document.getElementById('downloadLink').href = url;
    }

    window.addEventListener('load', function() {
    
    	wt.codeEditor = CodeMirror.fromTextArea(scriptTextarea, { lineNumbers: true, mode: "javascript", indentUnit: 2, smartIndent: false, tabSize: 2 });
    	wt.errorEditor = CodeMirror.fromTextArea(scriptErrorTextarea, { lineNumbers: true, mode: "javascript", indentUnit: 2, smartIndent: false, tabSize: 2, readOnly: true });
    	wt.codeEditor.setSize("100%", "100%");
    	wt.errorEditor.setSize("100%", "100%");
    	recompute();

    });
</script>

    <div class="controls">
		<table>
			<tr>
				<td>Wavetable Count</td>
				<td><input type="text" id="wavetableCount" value="256" /></td>
			</tr>
			<tr>
				<td>Table Size</td>
				<td><input type="text" id="wavetableCount" value="2048" /> </td>
			</tr>
			<tr>
				<td>Table Size</td>
				<td>
					<select id="midiInputSelectBox">
						<option>Midi 1</option>
						<option>Midi 2</option>
						<option>Midi 3</option>
						<option>Midi 4</option>
					</select>
				</td>
			</tr>
		</table>
		<table>
			<tr class="noteLinks">
				<td><a>C1</a></td>
				<td><a>C2</a></td>
				<td><a>C3</a></td>
				<td><a>C4</a></td>
				<td><a>C5</a></td>
				<td><a>C6</a></td>
			</tr>
			<tr>
				<td colspan="6"><input id="waveSlider" type="range" min="0" max="1" step="0.001" style="width:100%;" oninput="updateWave();" /></td>
			</tr>
			<tr>
				<td colspan="3"><a href="#" onclick="recompute();">Recompute</a></td>
				<td colspan="3"><a id="downloadLink" href="#" download="Wavetable.wav" onclick="downloadWave();">Download</a></td>
			</tr>
		</table>
    </div>

    <div class="codeEditor" style="height:300px;">
        <textarea id="scriptTextarea">

wt.initialize = function(N, K) {

}

wt.makeWave = function (k, N, K) {
    var output = new Array(N);
    var last = 0.0;
    for (var i = 0; i < N; i++) {
        var phase = i / N * 2 * Math.PI;
        var value = Math.sin(phase + k * 0.01 * last);
        last = value;
        output[i] = value;
    }

    return output;
}

        </textarea>
    </div>
    <div class="codeEditor" id="scriptError" style="height:200px;">
        <textarea id="scriptErrorTextarea"></textarea>
    </div>

    <canvas id="canvas" width="800" height="300" style="margin: 5px; border: 1px solid #999; background: #f0f0f0;"></canvas>
</body>
</html>
